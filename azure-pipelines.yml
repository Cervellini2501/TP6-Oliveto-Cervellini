# TP6 – Azure DevOps CI/CD Pipeline – Pruebas Unitarias (Backend .NET + Frontend Angular)

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

steps:
# 1️⃣ Instalar .NET 8
- task: UseDotNet@2
  inputs:
    version: '8.x'
  displayName: 'Instalar .NET 8 SDK'

# 2️⃣ Instalar Node.js (para Angular)
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Instalar Node.js 20'

# 3️⃣ Ejecutar pruebas del Backend (.NET + xUnit)
- script: |
    cd backend
    dotnet restore
    dotnet build --configuration $(buildConfiguration)
    dotnet test --configuration $(buildConfiguration) --logger "trx;LogFileName=test-backend.trx"
  displayName: 'Ejecutar pruebas Backend'

# 4️⃣ Ejecutar pruebas del Frontend (Angular + Jasmine)
- script: |
    cd frontend
    npm ci
    npm run test -- --watch=false --browsers ChromeHeadless || true
  displayName: 'Ejecutar pruebas Frontend'

# 5️⃣ Publicar resultados de pruebas Backend
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/test-backend.trx'
    failTaskOnFailedTests: true
  displayName: 'Publicar resultados Backend'

# 6️⃣ Publicar resultados de pruebas Frontend
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/test-results/test-results.xml'
    failTaskOnFailedTests: false
  displayName: 'Publicar resultados Frontend'
